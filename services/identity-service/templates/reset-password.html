{% extends "base.html" %}

{% block title %}Reset Password - Identity Service{% endblock %}

{% block content %}
<div class="card reset-password-card">
    {% if success %}
    <div class="success-state">
        <div class="success-icon">
            <svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="var(--success-color, #059669)" stroke-width="1.5">
                <path d="M22 11.08V12a10 10 0 11-5.93-9.14"/>
                <polyline points="22 4 12 14.01 9 11.01"/>
            </svg>
        </div>
        <h1>Password reset successful</h1>
        <p class="subtitle">Your password has been changed. You can now sign in with your new password.</p>
        <a href="/login{% if return_query %}?{{ return_query }}{% endif %}" class="btn btn-primary btn-block">
            Sign In
        </a>
    </div>
    {% elif invalid_token %}
    <div class="error-state">
        <div class="error-icon">
            <svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="var(--error-color, #DC2626)" stroke-width="1.5">
                <circle cx="12" cy="12" r="10"/>
                <line x1="15" y1="9" x2="9" y2="15"/>
                <line x1="9" y1="9" x2="15" y2="15"/>
            </svg>
        </div>
        <h1>Invalid or expired link</h1>
        <p class="subtitle">This password reset link is invalid or has expired. Please request a new one.</p>
        <a href="/forgot-password{% if return_query %}?{{ return_query }}{% endif %}" class="btn btn-primary btn-block">
            Request New Link
        </a>
        <div class="links">
            <a href="/login{% if return_query %}?{{ return_query }}{% endif %}">Back to Sign In</a>
        </div>
    </div>
    {% else %}
    <h1>Reset your password</h1>
    <p class="subtitle">Enter a new password for your account.</p>
    
    {% if error %}
    <div class="alert alert-error">
        <svg class="alert-icon" width="16" height="16" viewBox="0 0 16 16" fill="currentColor">
            <path d="M8 1a7 7 0 100 14A7 7 0 008 1zM7 5a1 1 0 012 0v3a1 1 0 01-2 0V5zm1 7a1 1 0 100-2 1 1 0 000 2z"/>
        </svg>
        <span>{{ error }}</span>
    </div>
    {% endif %}

    <form method="POST" action="/reset-password" id="resetForm">
        <input type="hidden" name="token" value="{{ token }}">
        
        <div class="form-group">
            <label for="password">New password</label>
            <div class="input-with-icon">
                <input 
                    type="password" 
                    id="password" 
                    name="password"
                    placeholder="At least 8 characters"
                    required
                    minlength="8"
                    autocomplete="new-password"
                >
                <button type="button" class="toggle-password" onclick="togglePassword('password', 'eyeIcon1', 'eyeOffIcon1')" aria-label="Toggle password visibility">
                    <svg id="eyeIcon1" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/>
                        <circle cx="12" cy="12" r="3"/>
                    </svg>
                    <svg id="eyeOffIcon1" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="display:none">
                        <path d="M17.94 17.94A10.07 10.07 0 0112 20c-7 0-11-8-11-8a18.45 18.45 0 015.06-5.94M9.9 4.24A9.12 9.12 0 0112 4c7 0 11 8 11 8a18.5 18.5 0 01-2.16 3.19m-6.72-1.07a3 3 0 11-4.24-4.24"/>
                        <line x1="1" y1="1" x2="23" y2="23"/>
                    </svg>
                </button>
            </div>
        </div>
        
        <div class="form-group">
            <label for="confirm_password">Confirm new password</label>
            <div class="input-with-icon">
                <input 
                    type="password" 
                    id="confirm_password" 
                    name="confirm_password"
                    placeholder="Re-enter your password"
                    required
                    minlength="8"
                    autocomplete="new-password"
                >
                <button type="button" class="toggle-password" onclick="togglePassword('confirm_password', 'eyeIcon2', 'eyeOffIcon2')" aria-label="Toggle password visibility">
                    <svg id="eyeIcon2" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/>
                        <circle cx="12" cy="12" r="3"/>
                    </svg>
                    <svg id="eyeOffIcon2" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="display:none">
                        <path d="M17.94 17.94A10.07 10.07 0 0112 20c-7 0-11-8-11-8a18.45 18.45 0 015.06-5.94M9.9 4.24A9.12 9.12 0 0112 4c7 0 11 8 11 8a18.5 18.5 0 01-2.16 3.19m-6.72-1.07a3 3 0 11-4.24-4.24"/>
                        <line x1="1" y1="1" x2="23" y2="23"/>
                    </svg>
                </button>
            </div>
        </div>

        <div class="password-requirements">
            <p class="requirements-title">Password must:</p>
            <ul>
                <li id="req-length" class="requirement">Be at least 8 characters long</li>
                <li id="req-upper" class="requirement">Contain an uppercase letter</li>
                <li id="req-lower" class="requirement">Contain a lowercase letter</li>
                <li id="req-number" class="requirement">Contain a number</li>
            </ul>
        </div>
        
        <button type="submit" class="btn btn-primary btn-block" id="submitBtn">
            <span class="btn-text">Reset Password</span>
            <span class="btn-loading" style="display:none">
                <svg class="spinner" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="12" cy="12" r="10" opacity="0.25"/>
                    <path d="M12 2a10 10 0 019.95 9" stroke-linecap="round"/>
                </svg>
                Resetting...
            </span>
        </button>
    </form>
    
    <div class="links">
        <a href="/login{% if return_query %}?{{ return_query }}{% endif %}">Back to Sign In</a>
    </div>
    {% endif %}
</div>
{% endblock %}

{% block scripts %}
<script>
function togglePassword(inputId, eyeId, eyeOffId) {
    var input = document.getElementById(inputId);
    var eye = document.getElementById(eyeId);
    var eyeOff = document.getElementById(eyeOffId);
    if (input.type === 'password') {
        input.type = 'text';
        eye.style.display = 'none';
        eyeOff.style.display = 'block';
    } else {
        input.type = 'password';
        eye.style.display = 'block';
        eyeOff.style.display = 'none';
    }
}

// Live password validation feedback
var passwordInput = document.getElementById('password');
if (passwordInput) {
    passwordInput.addEventListener('input', function() {
        var val = this.value;
        toggleReq('req-length', val.length >= 8);
        toggleReq('req-upper', /[A-Z]/.test(val));
        toggleReq('req-lower', /[a-z]/.test(val));
        toggleReq('req-number', /[0-9]/.test(val));
    });
}

function toggleReq(id, met) {
    var el = document.getElementById(id);
    if (el) {
        el.classList.toggle('met', met);
        el.classList.toggle('unmet', !met);
    }
}

// Confirm password match on submit
document.getElementById('resetForm')?.addEventListener('submit', function(e) {
    var pw = document.getElementById('password').value;
    var cpw = document.getElementById('confirm_password').value;
    if (pw !== cpw) {
        e.preventDefault();
        alert('Passwords do not match.');
        return;
    }
    var btn = document.getElementById('submitBtn');
    btn.querySelector('.btn-text').style.display = 'none';
    btn.querySelector('.btn-loading').style.display = 'inline-flex';
    btn.disabled = true;
});
</script>
{% endblock %}
