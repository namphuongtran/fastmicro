{% extends "base.html" %}

{% block title %}Forgot Password - Identity Service{% endblock %}

{% block content %}
<div class="card forgot-password-card">
    {% if submitted %}
    {# Success state â€” always show same message to prevent email enumeration #}
    <div class="success-state">
        <div class="success-icon">
            <svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="var(--success-color, #059669)" stroke-width="1.5">
                <path d="M22 12h-6l-2 3h-4l-2-3H2"/>
                <path d="M5.45 5.11L2 12v6a2 2 0 002 2h16a2 2 0 002-2v-6l-3.45-6.89A2 2 0 0016.76 4H7.24a2 2 0 00-1.79 1.11z"/>
            </svg>
        </div>
        <h1>Check your email</h1>
        <p class="subtitle">
            If an account exists for <strong>{{ email }}</strong>, 
            we've sent a password reset link. Please check your inbox and spam folder.
        </p>
        <p class="help-text">The link will expire in 1 hour.</p>
        <div class="links">
            <a href="/login{% if return_query %}?{{ return_query }}{% endif %}" class="btn btn-outline btn-block">
                Back to Sign In
            </a>
        </div>
    </div>
    {% else %}
    <h1>Forgot your password?</h1>
    <p class="subtitle">Enter the email address associated with your account and we'll send you a link to reset your password.</p>
    
    {% if error %}
    <div class="alert alert-error">
        <svg class="alert-icon" width="16" height="16" viewBox="0 0 16 16" fill="currentColor">
            <path d="M8 1a7 7 0 100 14A7 7 0 008 1zM7 5a1 1 0 012 0v3a1 1 0 01-2 0V5zm1 7a1 1 0 100-2 1 1 0 000 2z"/>
        </svg>
        <span>{{ error }}</span>
    </div>
    {% endif %}

    <form method="POST" action="/forgot-password" id="forgotForm">
        {# Preserve OIDC flow params so user can return to login with context #}
        {% if response_type %}
        <input type="hidden" name="response_type" value="{{ response_type }}">
        {% endif %}
        {% if client_id %}
        <input type="hidden" name="client_id" value="{{ client_id }}">
        {% endif %}
        {% if redirect_uri %}
        <input type="hidden" name="redirect_uri" value="{{ redirect_uri }}">
        {% endif %}
        {% if scope %}
        <input type="hidden" name="scope" value="{{ scope }}">
        {% endif %}
        {% if state %}
        <input type="hidden" name="state" value="{{ state }}">
        {% endif %}

        <div class="form-group">
            <label for="email">Email address</label>
            <input 
                type="email" 
                id="email" 
                name="email" 
                placeholder="you@example.com"
                required 
                autofocus
                autocomplete="email"
            >
        </div>
        
        <button type="submit" class="btn btn-primary btn-block" id="submitBtn">
            <span class="btn-text">Send Reset Link</span>
            <span class="btn-loading" style="display:none">
                <svg class="spinner" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="12" cy="12" r="10" opacity="0.25"/>
                    <path d="M12 2a10 10 0 019.95 9" stroke-linecap="round"/>
                </svg>
                Sending...
            </span>
        </button>
    </form>
    
    <div class="links">
        <a href="/login{% if return_query %}?{{ return_query }}{% endif %}">Back to Sign In</a>
    </div>
    {% endif %}
</div>
{% endblock %}

{% block scripts %}
<script>
document.getElementById('forgotForm')?.addEventListener('submit', function() {
    var btn = document.getElementById('submitBtn');
    btn.querySelector('.btn-text').style.display = 'none';
    btn.querySelector('.btn-loading').style.display = 'inline-flex';
    btn.disabled = true;
});
</script>
{% endblock %}
