{% extends "admin/base.html" %}

{% block title %}OAuth Clients - Identity Admin{% endblock %}
{% block page_title %}OAuth Clients{% endblock %}

{% block content %}
<div class="page-header">
    <div class="header-actions">
        <a href="/admin/clients/new" class="btn btn-primary">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <line x1="12" y1="5" x2="12" y2="19"></line>
                <line x1="5" y1="12" x2="19" y2="12"></line>
            </svg>
            New Client
        </a>
    </div>
</div>

<!-- Search and Filters -->
<div class="search-bar">
    <form method="GET" action="/admin/clients" class="search-form">
        <div class="search-input-wrapper">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="11" cy="11" r="8"></circle>
                <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
            </svg>
            <input type="text" name="q" placeholder="Search clients..." value="{{ request.args.get('q', '') }}">
        </div>
        <select name="type" class="filter-select">
            <option value="">All Types</option>
            <option value="confidential" {% if request.args.get('type') == 'confidential' %}selected{% endif %}>Confidential</option>
            <option value="public" {% if request.args.get('type') == 'public' %}selected{% endif %}>Public</option>
        </select>
        <select name="status" class="filter-select">
            <option value="">All Status</option>
            <option value="active" {% if request.args.get('status') == 'active' %}selected{% endif %}>Active</option>
            <option value="inactive" {% if request.args.get('status') == 'inactive' %}selected{% endif %}>Inactive</option>
        </select>
        <button type="submit" class="btn btn-secondary">Search</button>
    </form>
</div>

<!-- Clients Table -->
<div class="table-container">
    <table class="admin-table">
        <thead>
            <tr>
                <th>Client Name</th>
                <th>Client ID</th>
                <th>Type</th>
                <th>Status</th>
                <th>Created</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            {% if clients %}
                {% for client in clients %}
                <tr>
                    <td>
                        <div class="client-info">
                            <span class="client-name">{{ client.client_name }}</span>
                            {% if client.description %}
                            <span class="client-description">{{ client.description | truncate(50) }}</span>
                            {% endif %}
                        </div>
                    </td>
                    <td>
                        <code class="client-id">{{ client.client_id | truncate(20) }}</code>
                        <button class="copy-btn" data-copy="{{ client.client_id }}" title="Copy Client ID">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
                                <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
                            </svg>
                        </button>
                    </td>
                    <td>
                        <span class="badge badge-{{ client.client_type }}">{{ client.client_type }}</span>
                    </td>
                    <td>
                        {% if client.is_active %}
                        <span class="status-badge active">Active</span>
                        {% else %}
                        <span class="status-badge inactive">Inactive</span>
                        {% endif %}
                    </td>
                    <td>
                        <span class="date">{{ client.created_at.strftime('%Y-%m-%d') if client.created_at else 'N/A' }}</span>
                    </td>
                    <td>
                        <div class="action-buttons">
                            <a href="/admin/clients/{{ client.id }}" class="btn btn-sm btn-secondary" title="View Details">
                                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path>
                                    <circle cx="12" cy="12" r="3"></circle>
                                </svg>
                            </a>
                            <a href="/admin/clients/{{ client.id }}/edit" class="btn btn-sm btn-secondary" title="Edit">
                                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                                    <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
                                </svg>
                            </a>
                            <button class="btn btn-sm btn-danger delete-btn" 
                                    data-client-id="{{ client.id }}" 
                                    data-client-name="{{ client.client_name }}"
                                    title="Delete">
                                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <polyline points="3 6 5 6 21 6"></polyline>
                                    <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                                </svg>
                            </button>
                        </div>
                    </td>
                </tr>
                {% endfor %}
            {% else %}
            <tr>
                <td colspan="6" class="empty-cell">
                    <div class="empty-state">
                        <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1">
                            <rect x="2" y="3" width="20" height="14" rx="2" ry="2"></rect>
                            <line x1="8" y1="21" x2="16" y2="21"></line>
                            <line x1="12" y1="17" x2="12" y2="21"></line>
                        </svg>
                        <p>No OAuth clients found</p>
                        <a href="/admin/clients/new" class="btn btn-primary">Create your first client</a>
                    </div>
                </td>
            </tr>
            {% endif %}
        </tbody>
    </table>
</div>

<!-- Pagination -->
{% if pagination and pagination.total_pages > 1 %}
<div class="pagination">
    {% if pagination.has_prev %}
    <a href="?page={{ pagination.page - 1 }}" class="page-link">← Previous</a>
    {% endif %}
    
    <span class="page-info">Page {{ pagination.page }} of {{ pagination.total_pages }}</span>
    
    {% if pagination.has_next %}
    <a href="?page={{ pagination.page + 1 }}" class="page-link">Next →</a>
    {% endif %}
</div>
{% endif %}

<!-- Delete Confirmation Modal -->
<div id="deleteModal" class="modal">
    <div class="modal-content">
        <h3>Delete Client</h3>
        <p>Are you sure you want to delete <strong id="deleteClientName"></strong>?</p>
        <p class="warning-text">This action cannot be undone. All associated secrets and configurations will be permanently deleted.</p>
        <div class="modal-actions">
            <button class="btn btn-secondary" onclick="closeDeleteModal()">Cancel</button>
            <button class="btn btn-danger" id="confirmDeleteBtn">Delete Client</button>
        </div>
    </div>
</div>

<script>
// Copy to clipboard functionality
document.querySelectorAll('.copy-btn').forEach(btn => {
    btn.addEventListener('click', function() {
        const text = this.dataset.copy;
        navigator.clipboard.writeText(text).then(() => {
            this.classList.add('copied');
            setTimeout(() => this.classList.remove('copied'), 2000);
        });
    });
});

// Delete modal functionality
let deleteClientId = null;

document.querySelectorAll('.delete-btn').forEach(btn => {
    btn.addEventListener('click', function() {
        deleteClientId = this.dataset.clientId;
        document.getElementById('deleteClientName').textContent = this.dataset.clientName;
        document.getElementById('deleteModal').classList.add('active');
    });
});

function closeDeleteModal() {
    document.getElementById('deleteModal').classList.remove('active');
    deleteClientId = null;
}

document.getElementById('confirmDeleteBtn').addEventListener('click', function() {
    if (deleteClientId) {
        fetch(`/api/admin/clients/${deleteClientId}`, {
            method: 'DELETE',
            headers: {
                'Content-Type': 'application/json'
            }
        }).then(response => {
            if (response.ok) {
                window.location.reload();
            } else {
                alert('Failed to delete client');
            }
        });
    }
});

// Close modal on outside click
document.getElementById('deleteModal').addEventListener('click', function(e) {
    if (e.target === this) {
        closeDeleteModal();
    }
});
</script>
{% endblock %}
