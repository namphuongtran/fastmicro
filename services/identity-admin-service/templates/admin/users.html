{% extends "admin/base.html" %}

{% block title %}Users - Identity Admin{% endblock %}
{% block page_title %}Users{% endblock %}

{% block content %}
<div class="page-header">
    <div class="header-actions">
        <a href="/admin/users/new" class="btn btn-primary">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                <circle cx="8.5" cy="7" r="4"></circle>
                <line x1="20" y1="8" x2="20" y2="14"></line>
                <line x1="23" y1="11" x2="17" y2="11"></line>
            </svg>
            Add User
        </a>
    </div>
</div>

<!-- Search and Filters -->
<div class="search-bar">
    <form method="GET" action="/admin/users" class="search-form">
        <div class="search-input-wrapper">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="11" cy="11" r="8"></circle>
                <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
            </svg>
            <input type="text" name="q" placeholder="Search by username or email..." value="{{ request.args.get('q', '') }}">
        </div>
        <select name="status" class="filter-select">
            <option value="">All Status</option>
            <option value="active" {% if request.args.get('status') == 'active' %}selected{% endif %}>Active</option>
            <option value="inactive" {% if request.args.get('status') == 'inactive' %}selected{% endif %}>Inactive</option>
            <option value="locked" {% if request.args.get('status') == 'locked' %}selected{% endif %}>Locked</option>
        </select>
        <select name="role" class="filter-select">
            <option value="">All Roles</option>
            <option value="admin" {% if request.args.get('role') == 'admin' %}selected{% endif %}>Admin</option>
            <option value="user" {% if request.args.get('role') == 'user' %}selected{% endif %}>User</option>
            <option value="service" {% if request.args.get('role') == 'service' %}selected{% endif %}>Service Account</option>
        </select>
        <button type="submit" class="btn btn-secondary">Search</button>
    </form>
</div>

<!-- Users Table -->
<div class="table-container">
    <table class="admin-table">
        <thead>
            <tr>
                <th>User</th>
                <th>Email</th>
                <th>Status</th>
                <th>Roles</th>
                <th>Last Login</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            {% if users %}
                {% for user in users %}
                <tr>
                    <td>
                        <div class="user-info">
                            <div class="user-avatar">
                                {{ user.username[0] | upper if user.username else '?' }}
                            </div>
                            <div class="user-details">
                                <span class="username">{{ user.username }}</span>
                                {% if user.profile and user.profile.display_name %}
                                <span class="display-name">{{ user.profile.display_name }}</span>
                                {% endif %}
                            </div>
                        </div>
                    </td>
                    <td>
                        <span class="email">{{ user.email }}</span>
                        {% if user.email_verified %}
                        <span class="verified-badge" title="Email Verified">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path>
                                <polyline points="22 4 12 14.01 9 11.01"></polyline>
                            </svg>
                        </span>
                        {% endif %}
                    </td>
                    <td>
                        {% if user.is_locked %}
                        <span class="status-badge locked">Locked</span>
                        {% elif user.is_active %}
                        <span class="status-badge active">Active</span>
                        {% else %}
                        <span class="status-badge inactive">Inactive</span>
                        {% endif %}
                    </td>
                    <td>
                        <div class="role-badges">
                            {% if user.roles %}
                                {% for role in user.roles[:3] %}
                                <span class="badge badge-role">{{ role.role_name }}</span>
                                {% endfor %}
                                {% if user.roles | length > 3 %}
                                <span class="badge badge-more">+{{ user.roles | length - 3 }}</span>
                                {% endif %}
                            {% else %}
                            <span class="no-roles">No roles</span>
                            {% endif %}
                        </div>
                    </td>
                    <td>
                        {% if user.last_login_at %}
                        <span class="date" title="{{ user.last_login_at }}">{{ user.last_login_at.strftime('%Y-%m-%d %H:%M') }}</span>
                        {% else %}
                        <span class="never">Never</span>
                        {% endif %}
                    </td>
                    <td>
                        <div class="action-buttons">
                            <a href="/admin/users/{{ user.id }}" class="btn btn-sm btn-secondary" title="View Details">
                                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path>
                                    <circle cx="12" cy="12" r="3"></circle>
                                </svg>
                            </a>
                            <a href="/admin/users/{{ user.id }}/edit" class="btn btn-sm btn-secondary" title="Edit">
                                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                                    <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
                                </svg>
                            </a>
                            {% if user.is_locked %}
                            <button class="btn btn-sm btn-warning unlock-btn" 
                                    data-user-id="{{ user.id }}" 
                                    data-username="{{ user.username }}"
                                    title="Unlock User">
                                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect>
                                    <path d="M7 11V7a5 5 0 0 1 9.9-1"></path>
                                </svg>
                            </button>
                            {% endif %}
                            <button class="btn btn-sm btn-danger delete-btn" 
                                    data-user-id="{{ user.id }}" 
                                    data-username="{{ user.username }}"
                                    title="Delete">
                                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <polyline points="3 6 5 6 21 6"></polyline>
                                    <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                                </svg>
                            </button>
                        </div>
                    </td>
                </tr>
                {% endfor %}
            {% else %}
            <tr>
                <td colspan="6" class="empty-cell">
                    <div class="empty-state">
                        <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1">
                            <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                            <circle cx="9" cy="7" r="4"></circle>
                            <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
                            <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
                        </svg>
                        <p>No users found</p>
                        <a href="/admin/users/new" class="btn btn-primary">Add first user</a>
                    </div>
                </td>
            </tr>
            {% endif %}
        </tbody>
    </table>
</div>

<!-- Pagination -->
{% if pagination and pagination.total_pages > 1 %}
<div class="pagination">
    {% if pagination.has_prev %}
    <a href="?page={{ pagination.page - 1 }}" class="page-link">← Previous</a>
    {% endif %}
    
    <span class="page-info">Page {{ pagination.page }} of {{ pagination.total_pages }}</span>
    
    {% if pagination.has_next %}
    <a href="?page={{ pagination.page + 1 }}" class="page-link">Next →</a>
    {% endif %}
</div>
{% endif %}

<!-- Delete Confirmation Modal -->
<div id="deleteModal" class="modal">
    <div class="modal-content">
        <h3>Delete User</h3>
        <p>Are you sure you want to delete <strong id="deleteUsername"></strong>?</p>
        <p class="warning-text">This action cannot be undone. All user data, sessions, and associated tokens will be permanently deleted.</p>
        <div class="modal-actions">
            <button class="btn btn-secondary" onclick="closeDeleteModal()">Cancel</button>
            <button class="btn btn-danger" id="confirmDeleteBtn">Delete User</button>
        </div>
    </div>
</div>

<!-- Unlock Confirmation Modal -->
<div id="unlockModal" class="modal">
    <div class="modal-content">
        <h3>Unlock User</h3>
        <p>Are you sure you want to unlock <strong id="unlockUsername"></strong>?</p>
        <p>This will reset the failed login counter and allow the user to log in again.</p>
        <div class="modal-actions">
            <button class="btn btn-secondary" onclick="closeUnlockModal()">Cancel</button>
            <button class="btn btn-primary" id="confirmUnlockBtn">Unlock User</button>
        </div>
    </div>
</div>

<script>
// Delete modal functionality
let deleteUserId = null;

document.querySelectorAll('.delete-btn').forEach(btn => {
    btn.addEventListener('click', function() {
        deleteUserId = this.dataset.userId;
        document.getElementById('deleteUsername').textContent = this.dataset.username;
        document.getElementById('deleteModal').classList.add('active');
    });
});

function closeDeleteModal() {
    document.getElementById('deleteModal').classList.remove('active');
    deleteUserId = null;
}

document.getElementById('confirmDeleteBtn').addEventListener('click', function() {
    if (deleteUserId) {
        fetch(`/api/admin/users/${deleteUserId}`, {
            method: 'DELETE',
            headers: {
                'Content-Type': 'application/json'
            }
        }).then(response => {
            if (response.ok) {
                window.location.reload();
            } else {
                alert('Failed to delete user');
            }
        });
    }
});

// Unlock modal functionality
let unlockUserId = null;

document.querySelectorAll('.unlock-btn').forEach(btn => {
    btn.addEventListener('click', function() {
        unlockUserId = this.dataset.userId;
        document.getElementById('unlockUsername').textContent = this.dataset.username;
        document.getElementById('unlockModal').classList.add('active');
    });
});

function closeUnlockModal() {
    document.getElementById('unlockModal').classList.remove('active');
    unlockUserId = null;
}

document.getElementById('confirmUnlockBtn').addEventListener('click', function() {
    if (unlockUserId) {
        fetch(`/api/admin/users/${unlockUserId}/unlock`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }
        }).then(response => {
            if (response.ok) {
                window.location.reload();
            } else {
                alert('Failed to unlock user');
            }
        });
    }
});

// Close modals on outside click
document.querySelectorAll('.modal').forEach(modal => {
    modal.addEventListener('click', function(e) {
        if (e.target === this) {
            this.classList.remove('active');
        }
    });
});
</script>
{% endblock %}
